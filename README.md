# Exploit-CVE-2023-22518

CVE-2023-22518 in Confluence

CVE-2023-22518 : Lỗ hổng này được mô tả là “lỗ hổng về việc ủy quyền không đúng cách trong cơ sở dữ liệu và máy chủ của Confluence”. Lỗi ảnh hưởng tới các phiên bản On-premises của các sản phẩm Atlassian.

Set up môi trường 
Sử dụng version bị lỗi 8.0.4
URL Download : https://product-downloads.atlassian.com/software/confluence/downloads/atlassian-confluence-8.0.4-x64.exe

< ảnh trial>

Chọn Trial Installation, sau đó click vào link để lấy free trial key . Sau đó setup cluster : chọn non-cluster
<ảnh cluster>

Sau đó đến với setup database -> Chọn MySQL

<ảnh>

Làm theo hướng dẫn :
1. Download the MySQL driver
2. Drop the .jar file in /home/lily/atlassian/confluence/confluence/WEB-INF/lib 
3. Restart Confluence and continue the setup process.
<Hình 4 : chạy lệnh để nhập code vào>
Cấu hình database, tạo user và password table 
```
CREATE DATABASE securedb CHARACTER SET utf8mb4 COLLATE utf8mb4_bin;
CREATE USER 'admin123'@'localhost' IDENTIFIED BY 'supersecure';
GRANT ALL PRIVILEGES ON securedb.* TO 'admin123'@'localhost';
GRANT SUPER ON *.* TO 'your_username'@'your_host';
FLUSH PRIVILEGES;
```
Sau đó edit /etc/mysql/my.cnf . Thêm các dòng sau vào :
```
transaction-isolation = READ-COMMITTED
log_bin_trust_function_creators = 1
```
<hình 5>
Sau đó restart Mysql và Conflunce . Rồi vào trang cài đặt ở localhost:8090 và sử dụng database đã tạo điền vào 
<hình 6>

Check connection success , click Next . Sau đó Sign up . 
<Hình 7>

Diff
diff hai file jar của 2 version lên IntelliJ
<hình 8>

Sự khác biệt giữa bản vá và bản chưa vá là @WebSudoRequired và @SystemAdminOnly
websudorequired là tính năng để nâng cao bảo mật của administrator sessions. Khi cố truy cập vào admin , hệ thống sẽ yêu cầu nhập lại mật khẩu dù bạn đã đăng nhập vào hệ thống. Bổ sung một bước xác thực bổ sung để đảm bảo về quyền truy cập quản trị
SystemAdminOnly : Là tính năng , nó giới hạn chức năng quản trị chỉ cho các tài khoản quản trị viên. Điều này giúp đảm bảo chỉ các tài khoản được ủy quyền mới được có thể thực hiện các thao tác quan trọng và ảnh hưởng đến hệ thống.

Điều này dẫn đến nghi ngờ về việc bản 8.0.4 có khả năng xuất hiện lỗi về ủy quyền . Chuyển hướng chú ý sang tep struts.xml  tệp này chứa thông tin về hành động và định tuyến dựa trên vùng tên cũng như các trình chặn .

< hình 9>

Ta thấy không gian tên /json tăng cường chức năng của không gian tên /admin. Do đó, các tuyến được tạo cho không gian tên /admin cũng có thể được truy cập thông qua không gian tên /json.

Trong ngữ cảnh của không gian tên /json, quy trình định tuyến yêu cầu bao gồm việc chuyển qua một loạt các thiết bị chặn. Một trong những thiết bị chặn này, được gọi là WebSudoInterceptor, thực hiện kiểm tra dựa trên URI yêu cầu.

Cụ thể, WebSudoInterceptor thực hiện các bước kiểm tra sau:

Nếu đường dẫn yêu cầu là /authenticate.action thì nó sẽ bị bỏ qua.
Nếu đường dẫn yêu cầu là /admin, nó sẽ kiểm tra xem thuộc tính WebSudoNotRequired có rỗng hay không.


Bắt request burpsuite , GET /json/setup-restore.action . Tuy nhiên nhận được phản hồi "Method Not Allowed response" .
Thử với việc POST /json/setup-restore.action?synchronous=true
và nhận được phản hồi 200 
<ảnh 10 , post thanh công>
<ảnh 11>
Upload file xmlexport-200123123001.zip
<ảnh 12>
lên và nhận phản hồi 
<ảnh 13 >
Bây giờ cta có thể đăng nhập vào với account admin :admin 
<hình 14>
<ảnh thành quả  15 >
